# 报表BI系统设计文档

## 1. 项目概述

### 1.1 项目背景
本系统是一个报表BI（商业智能）系统，旨在为业务人员提供可视化的数据分析和报表设计能力。系统通过拖拽式操作，让非技术人员也能轻松创建专业的数据报表和可视化图表。

### 1.2 项目目标
- 提供直观的拖拽式报表设计界面
- 支持多种图表类型和组件
- 灵活的数据源绑定机制
- 支持SQL查询和高级数据过滤
- 轻量化部署，使用SQLite数据库

### 1.3 技术选型
- **后端语言**: Python
- **数据库**: SQLite（轻量化存储）
- **前端框架**: React
- **后端框架**: Flask
- **前端UI库**: Ant Design
- **图表库**: ECharts
- **拖拽库**: react-dnd 或 react-beautiful-dnd

## 2. 系统架构设计

### 2.1 整体架构
```
┌─────────────────────────────────────────┐
│           前端展示层                      │
│  (报表设计器、图表组件、数据源配置)        │
└──────────────┬──────────────────────────┘
               │ HTTP/WebSocket
┌──────────────▼──────────────────────────┐
│           后端服务层                      │
│  (API接口、业务逻辑、数据处理)            │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│           数据存储层                      │
│  (SQLite数据库、数据集管理)               │
└─────────────────────────────────────────┘
```

### 2.2 模块划分
- **报表设计模块**: 拖拽式报表编辑器
- **图表组件模块**: 各类图表组件库
- **数据源管理模块**: 数据集、数据表、字段管理
- **数据查询模块**: SQL查询、过滤器处理
- **报表渲染模块**: 报表预览和导出（预览功能已实现）
- **用户管理模块**: 用户权限和报表分享

## 3. 功能模块详细设计

### 3.1 报表设计模块

#### 3.1.1 拖拽式设计器（已实现）
**功能描述**: 提供可视化的报表设计界面，支持拖拽组件到画布

**核心功能**:
- 组件库展示（折线图、饼图、下拉列表、文本框、树图等）
- 画布区域（支持多组件布局）
- 属性配置面板
- 组件选择、移动、删除、复制
- 组件自由拖拽（已修复拖拽时组件消失的问题）
- 报表预览功能（已实现）

**技术实现**:
- 前端使用React + react-dnd实现拖拽功能
- 组件配置JSON格式存储
- 实时预览功能
- 使用React Hooks管理组件状态
- 使用空预览（preview(null)）保持原始组件在拖拽时可见
- 在hover时实时更新组件位置，确保组件跟随鼠标移动

**拖拽优化**:
- 组件在拖拽时始终可见，不会消失
- 支持画布滚动时的正确位置计算
- 组件位置实时跟随鼠标移动
- 支持从组件库拖拽到画布，也支持在画布上移动已有组件

#### 3.1.3 报表预览功能（已实现）
**功能描述**: 提供独立的报表预览页面，用于查看报表的最终效果

**核心功能**:
- 独立预览页面，无编辑功能
- 完整渲染所有报表组件
- 支持条件数据源的动态数据加载
- 支持组件间的数据交互（条件数据源）
- 自动计算画布大小，适应所有组件
- 从报表列表和设计器都可以进入预览

**技术实现**:
- 创建独立的`ReportPreview`页面组件
- 使用`ChartComponent`渲染所有组件
- 实现`getComponentValue`函数支持组件间数据获取
- 根据组件位置自动计算画布尺寸
- 支持条件数据源的完整评估逻辑

**使用场景**:
- 在设计器中点击"预览"按钮查看报表效果
- 在报表列表中点击"预览"按钮快速查看报表
- 验证报表配置是否正确
- 查看条件数据源的实际效果

**界面特点**:
- 纯展示模式，无编辑功能
- 白色背景，模拟打印效果
- 自动居中显示
- 支持滚动查看大尺寸报表

#### 3.1.2 支持的图表类型

**1. 折线图 (Line Chart)**
- 用途: 展示数据趋势变化
- 配置项:
  - X轴字段
  - Y轴字段（支持多系列）
  - 图例位置
  - 颜色配置
  - 数据标签显示

**2. 饼图 (Pie Chart)**
- 用途: 展示数据占比关系
- 配置项:
  - 分类字段
  - 数值字段
  - 图例位置
  - 标签显示方式

**3. 下拉列表 (Dropdown)**
- 用途: 数据筛选控件
- 配置项:
  - 数据源字段
  - 默认值
  - 是否多选
  - 占位符文本

**4. 文本框 (Text Input)**
- 用途: 文本输入和筛选
- 配置项:
  - 默认值
  - 占位符
  - 输入类型（文本/数字/日期）
  - 验证规则

**5. 树图 (Tree Chart)**
- 用途: 展示层级关系数据
- 配置项:
  - 父节点字段
  - 子节点字段
  - 数值字段
  - 展开层级

### 3.2 数据源绑定模块

#### 3.2.1 基本功能流程

**流程步骤**:
1. **选择数据集**
   - 显示已配置的数据集列表
   - 支持数据集搜索和筛选
   - 数据集信息展示（名称、描述、更新时间）

2. **选择数据表**
   - 根据选择的数据集，展示该数据集下的所有数据表
   - 显示表结构预览（字段名、类型、示例数据）
   - 支持表搜索

3. **选择字段**
   - 根据图表类型，展示相应的字段选择界面
   - 折线图: 选择X轴字段、Y轴字段
   - 饼图: 选择分类字段、数值字段
   - 下拉列表: 选择选项字段
   - 文本框: 选择关联字段
   - 树图: 选择层级字段和数值字段

**数据模型**:
```python
# 数据集模型
class Dataset:
    id: int
    name: str
    description: str
    database_path: str
    created_at: datetime
    updated_at: datetime

# 数据表模型
class DataTable:
    id: int
    dataset_id: int
    table_name: str
    display_name: str
    schema_info: dict  # 表结构信息

# 字段模型
class Field:
    id: int
    table_id: int
    field_name: str
    field_type: str  # string, number, date, etc.
    display_name: str
```

#### 3.2.2 SQL查询方式

**功能描述**: 支持用户直接输入SQL查询语句来获取数据

**实现要点**:
- SQL编辑器（支持语法高亮）
- SQL语法验证
- 参数化查询支持（防止SQL注入）
- 查询结果预览
- 查询性能优化提示

**接口设计**:
```python
POST /api/data/query
{
    "sql": "SELECT * FROM table WHERE condition = ?",
    "params": ["value"],
    "dataset_id": 1
}
```

#### 3.2.3 条件数据源功能（已实现）

**功能描述**: 支持根据条件动态选择不同的数据源，实现灵活的数据绑定机制。

**核心特性**:
- **条件类型**: 支持静态值和组件值两种条件值类型
- **操作符**: 支持 =, !=, >, <, >=, <=, IN, LIKE 等多种操作符
- **默认数据源**: 当没有条件匹配时，使用默认数据源
- **多条件支持**: 可以配置多个条件，按顺序匹配第一个满足的条件

**配置界面**:
- 选择"条件数据源"类型时，弹出独立的配置窗口（Modal）
- Modal窗口提供更大的配置空间，界面更清晰
- 支持配置默认数据源和多个条件数据源

**数据源配置结构**:
```typescript
interface DataSourceConfig {
    type: 'table' | 'conditional';
    // 固定数据源配置
    datasetId?: number;
    tableName?: string;
    // 条件数据源配置
    conditionalSources?: ConditionalDataSource[];
    defaultSource?: {
        datasetId: number;
        tableName?: string;
    };
    fields: Record<string, string>;
    filters?: Filter[];
}

interface ConditionalDataSource {
    condition: {
        field?: string;           // 条件字段（可选）
        operator: '=' | '!=' | '>' | '<' | '>=' | '<=' | 'IN' | 'LIKE';
        valueType: 'static' | 'component';
        staticValue?: any;        // 静态值
        componentId?: string;     // 来源组件ID
        componentField?: string;  // 组件字段名
    };
    datasetId: number;
    tableName?: string;
}
```

**使用场景**:
1. **静态条件**: 根据固定的条件值选择数据源
   - 例如：当地区="north"时，使用数据集1；当地区="south"时，使用数据集2
2. **动态条件**: 根据其他组件的值选择数据源
   - 例如：当下拉列表选择的值="A"时，使用数据集1；选择="B"时，使用数据集2

**实现流程**:
1. 在属性面板中选择"条件数据源"类型
2. 点击"配置条件数据源"按钮打开配置窗口
3. 配置默认数据源（当没有条件匹配时使用）
4. 添加条件数据源，配置条件规则和对应的数据源
5. 系统在运行时根据条件自动选择合适的数据源

#### 3.2.4 数据库浏览功能（已实现）

**功能描述**: 提供可视化的数据库浏览和管理界面，支持查看和操作数据库内容。

**核心功能**:
- **数据集管理**:
  - 查看数据集列表
  - 创建新数据集（自动创建对应的SQLite数据库文件）
  - 选择数据集查看其数据表
- **数据表管理**:
  - 查看数据表列表
  - 创建新数据表（支持动态定义字段）
  - 向现有表添加新字段
  - 查看表结构和数据
- **数据管理**:
  - 查看表数据（支持分页）
  - 添加新数据（根据表结构动态生成表单）
  - 数据展示（表格形式）

**界面布局**:
```
┌─────────────────────────────────────────┐
│  顶部工具栏（返回、新建数据集、新建表等）  │
├──────────┬──────────────────────────────┤
│          │                              │
│ 数据表   │        数据展示区域          │
│ 列表     │      （表格、分页）          │
│          │                              │
│ - 表1    │                              │
│ - 表2    │                              │
│          │                              │
└──────────┴──────────────────────────────┘
```

**API接口**:
- `POST /api/datasets` - 创建数据集（支持指定数据库文件名）
- `POST /api/datasets/{id}/tables` - 创建数据表（支持动态字段定义）
- `POST /api/datasets/{id}/tables/{table}/columns` - 向表添加字段
- `POST /api/data/insert` - 插入数据到指定表

**字段定义**:
创建表时支持配置字段的以下属性：
- 字段名
- 字段类型（INTEGER, REAL, TEXT, BLOB, DATE）
- 是否主键
- 是否非空
- 默认值

## 4. 数据库设计

### 4.1 系统数据库（SQLite）

#### 4.1.1 数据集表 (datasets)
```sql
CREATE TABLE datasets (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    database_path VARCHAR(255) NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.2 报表表 (reports)
```sql
CREATE TABLE reports (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    config JSON NOT NULL,  -- 报表配置JSON（包含组件布局、数据绑定等）
    created_by VARCHAR(50),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### 4.1.3 数据表信息表 (data_tables)
```sql
CREATE TABLE data_tables (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    dataset_id INTEGER NOT NULL,
    table_name VARCHAR(100) NOT NULL,
    display_name VARCHAR(100),
    schema_info TEXT,  -- JSON格式存储表结构信息
    FOREIGN KEY (dataset_id) REFERENCES datasets(id)
);
```

#### 4.1.4 过滤器映射表 (filter_mappings)
```sql
CREATE TABLE filter_mappings (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    report_id INTEGER,
    filter_field VARCHAR(100) NOT NULL,
    filter_value VARCHAR(255),
    dataset_id INTEGER NOT NULL,
    FOREIGN KEY (report_id) REFERENCES reports(id),
    FOREIGN KEY (dataset_id) REFERENCES datasets(id)
);
```

#### 4.1.5 数据集选择规则表 (dataset_selection_rules)
```sql
CREATE TABLE dataset_selection_rules (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name VARCHAR(100) NOT NULL,
    algorithm_type VARCHAR(50) NOT NULL,  -- load_balance, time_partition, business_rule, performance
    rule_config TEXT,  -- JSON格式存储规则配置
    priority INTEGER DEFAULT 0,
    enabled BOOLEAN DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 业务数据数据库

每个数据集对应一个独立的SQLite数据库文件，存储实际的业务数据。系统通过动态连接这些数据库来查询数据。

## 5. API接口设计

### 5.1 数据集管理接口

#### 5.1.1 获取数据集列表
```
GET /api/datasets
Response: {
    "code": 200,
    "data": [
        {
            "id": 1,
            "name": "销售数据集",
            "description": "销售相关数据",
            "created_at": "2024-01-01 10:00:00"
        }
    ]
}
```

#### 5.1.2 创建数据集
```
POST /api/datasets
Request: {
    "name": "新数据集",
    "description": "描述",
    "database_path": "/path/to/database.db"
}
```

#### 5.1.3 获取数据表列表
```
GET /api/datasets/{dataset_id}/tables
Response: {
    "code": 200,
    "data": [
        {
            "id": 1,
            "table_name": "sales",
            "display_name": "销售表",
            "schema_info": {
                "fields": [
                    {"name": "id", "type": "INTEGER"},
                    {"name": "amount", "type": "REAL"}
                ]
            }
        }
    ]
}
```

### 5.2 报表管理接口

#### 5.2.1 创建报表
```
POST /api/reports
Request: {
    "name": "销售报表",
    "description": "月度销售报表",
    "config": {
        "components": [
            {
                "type": "line_chart",
                "position": {"x": 0, "y": 0, "width": 600, "height": 400},
                "data_source": {
                    "dataset_id": 1,
                    "table_name": "sales",
                    "fields": {
                        "x": "date",
                        "y": "amount"
                    }
                }
            }
        ]
    }
}
```

#### 5.2.2 获取报表列表
```
GET /api/reports
```

#### 5.2.3 获取报表详情
```
GET /api/reports/{report_id}
```

#### 5.2.4 更新报表
```
PUT /api/reports/{report_id}
Request: {
    "name": "更新后的报表名",
    "config": {...}
}
```

#### 5.2.5 删除报表
```
DELETE /api/reports/{report_id}
```

### 5.3 数据查询接口

#### 5.3.1 SQL查询
```
POST /api/data/query
Request: {
    "dataset_id": 1,
    "sql": "SELECT * FROM sales WHERE date >= ? AND date <= ?",
    "params": ["2024-01-01", "2024-01-31"]
}
Response: {
    "code": 200,
    "data": [
        {"id": 1, "date": "2024-01-01", "amount": 1000},
        ...
    ],
    "columns": ["id", "date", "amount"]
}
```

#### 5.3.2 获取表数据
```
POST /api/data/table-data
Request: {
    "dataset_id": 1,
    "table_name": "sales",
    "filters": [
        {"field": "date", "operator": ">=", "value": "2024-01-01"}
    ],
    "limit": 100,
    "offset": 0
}
```

#### 5.3.3 数据集选择
```
POST /api/data/select-dataset
Request: {
    "query_params": {
        "time_range": "2024-01",
        "region": "north"
    },
    "algorithm": "time_partition"
}
Response: {
    "code": 200,
    "data": {
        "dataset_id": 1,
        "dataset_name": "销售数据集-2024-01"
    }
}
```

### 5.4 过滤器映射接口

#### 5.4.1 创建过滤器映射
```
POST /api/filter-mappings
Request: {
    "report_id": 1,
    "filter_field": "region",
    "filter_value": "north",
    "dataset_id": 1
}
```

#### 5.4.2 获取过滤器映射列表
```
GET /api/filter-mappings?report_id=1
```

## 6. 前端设计

### 6.0 技术栈
- **框架**: React 18+
- **状态管理**: React Hooks (useState, useEffect)
- **路由**: React Router
- **UI组件库**: Ant Design
- **图表库**: ECharts (echarts-for-react)
- **拖拽库**: react-dnd
- **HTTP客户端**: Axios
- **构建工具**: Vite
- **TypeScript**: 使用TypeScript进行类型安全开发

### 6.1 页面结构

#### 6.1.1 报表设计器页面
```
┌─────────────────────────────────────────────────┐
│  顶部工具栏（返回、保存、预览）                    │
├──────────┬──────────────────────────────────────┤
│          │                                      │
│ 组件库   │          画布区域                     │
│          │      （可拖拽放置组件）               │
│ - 折线图 │                                      │
│ - 饼图   │                                      │
│ - 下拉   │                                      │
│ - 文本框 │                                      │
│ - 树图   │                                      │
│          │                                      │
├──────────┴──────────────────────────────────────┤
│  属性配置面板（选中组件后显示配置项）              │
└─────────────────────────────────────────────────┘
```

#### 6.1.1.1 报表预览页面（已实现）
```
┌─────────────────────────────────────────────────┐
│  顶部工具栏（返回、编辑报表）                      │
├─────────────────────────────────────────────────┤
│                                                  │
│           报表预览区域                           │
│  ┌──────────────────────────────────────────┐ │
│  │                                            │ │
│  │  组件1（折线图）                            │ │
│  │                                            │ │
│  │  组件2（饼图）                              │ │
│  │                                            │ │
│  │  组件3（下拉列表）                          │ │
│  │                                            │ │
│  └──────────────────────────────────────────┘ │
│                                                  │
│  （自动计算画布大小，支持滚动）                    │
└─────────────────────────────────────────────────┘
```

#### 6.1.2 数据源配置

**固定数据源配置**:
在属性面板中直接配置：
- 选择数据集
- 选择数据表
- 选择字段（根据图表类型）

**条件数据源配置窗口**（已实现）:
```
┌─────────────────────────────────────┐
│  条件数据源配置                      │
├─────────────────────────────────────┤
│  默认数据源                          │
│  - 默认数据集: [选择]                │
│  - 默认数据表: [选择]                │
│                                      │
│  条件数据源                          │
│  ┌──────────────────────────────┐  │
│  │ 条件 1                    [删除]│  │
│  │ - 条件字段: [输入]              │  │
│  │ - 操作符: [选择]                │  │
│  │ - 值类型: ○静态值 ○组件值       │  │
│  │ - 静态值/组件: [输入/选择]       │  │
│  │ - 数据集: [选择]                │  │
│  │ - 数据表: [选择]                │  │
│  └──────────────────────────────┘  │
│  [添加条件数据源]                     │
│                                      │
│  [关闭]                              │
└─────────────────────────────────────┘
```

**数据库浏览页面**（已实现）:
```
┌─────────────────────────────────────┐
│  数据库浏览                          │
├──────────┬──────────────────────────┤
│          │                           │
│ 数据表   │      数据展示区域         │
│ 列表     │  ┌─────────────────────┐ │
│          │  │ 表数据（表格）       │ │
│ - 表1    │  │                     │ │
│ - 表2    │  │ [分页控件]           │ │
│          │  └─────────────────────┘ │
│          │  [添加数据]               │
│          │                           │
└──────────┴──────────────────────────┘
```

### 6.2 组件设计

#### 6.2.1 图表组件基类
- 统一的组件接口
- 统一的数据格式
- 统一的配置项管理
- 统一的渲染方法

#### 6.2.2 组件配置结构
```typescript
interface ComponentConfig {
    id: string;
    type: 'line_chart' | 'pie_chart' | 'dropdown' | 'text_input' | 'tree_chart';
    position: {
        x: number;
        y: number;
        width: number;
        height: number;
    };
    style: {
        backgroundColor?: string;
        borderColor?: string;
        fontSize?: number;
    };
    dataSource: {
        type: 'table' | 'sql' | 'conditional';
        datasetId?: number;
        tableName?: string;
        sql?: string;
        fields: Record<string, string>;
        filters?: Filter[];
        // 条件数据源配置
        conditionalSources?: ConditionalDataSource[];
        defaultSource?: {
            datasetId: number;
            tableName?: string;
        };
    };
    props: Record<string, any>;  // 组件特定属性
}
```

### 6.3 React组件结构

#### 6.3.1 主要组件目录结构
```
src/
├── components/          # 通用组件
│   ├── ChartComponents/  # 图表组件
│   │   ├── LineChart.tsx
│   │   ├── PieChart.tsx
│   │   ├── TreeChart.tsx
│   │   └── index.ts
│   ├── FormComponents/   # 表单组件
│   │   ├── Dropdown.tsx
│   │   └── TextInput.tsx
│   └── Common/           # 通用UI组件
├── pages/              # 页面组件
│   ├── ReportDesigner/   # 报表设计器
│   ├── ReportList/       # 报表列表
│   └── DataSourceConfig/ # 数据源配置
├── store/              # 状态管理
│   ├── slices/
│   └── index.ts
├── services/           # API服务
│   ├── api.ts
│   └── datasetService.ts
├── hooks/              # 自定义Hooks
├── utils/              # 工具函数
└── types/              # TypeScript类型定义
```

#### 6.3.2 核心组件示例
```typescript
// ReportDesigner.tsx - 报表设计器主组件
import React from 'react';
import { DndProvider } from 'react-dnd';
import { HTML5Backend } from 'react-dnd-html5-backend';
import ComponentLibrary from './ComponentLibrary';
import Canvas from './Canvas';
import PropertyPanel from './PropertyPanel';

const ReportDesigner: React.FC = () => {
    return (
        <DndProvider backend={HTML5Backend}>
            <div className="report-designer">
                <ComponentLibrary />
                <Canvas />
                <PropertyPanel />
            </div>
        </DndProvider>
    );
};
```

## 7. 后端设计

### 7.0 Flask技术栈
- **Web框架**: Flask 2.3+
- **ORM**: SQLAlchemy（可选，也可直接使用sqlite3）
- **API扩展**: Flask-RESTful 或 Flask-RESTX
- **CORS支持**: Flask-CORS
- **配置管理**: python-dotenv
- **数据验证**: marshmallow 或 pydantic
- **日志**: Python logging模块

### 7.1 项目结构
```
biservicetest/
├── app/
│   ├── __init__.py      # Flask应用初始化
│   ├── models/          # 数据模型
│   │   ├── __init__.py
│   │   ├── dataset.py
│   │   ├── report.py
│   │   └── data_table.py
│   ├── api/             # API路由（Blueprint）
│   │   ├── __init__.py
│   │   ├── datasets.py
│   │   ├── reports.py
│   │   └── data.py
│   ├── services/        # 业务逻辑
│   │   ├── __init__.py
│   │   ├── dataset_service.py
│   │   ├── report_service.py
│   │   └── data_service.py
│   ├── utils/           # 工具类
│   │   ├── __init__.py
│   │   ├── database.py
│   │   ├── sql_validator.py
│   │   └── dataset_selector.py
│   └── config.py        # 配置文件
├── database/
│   └── system.db        # 系统数据库
├── datasets/            # 业务数据集目录
│   ├── dataset1.db
│   └── dataset2.db
├── .env                 # 环境变量配置
├── requirements.txt
└── app.py               # Flask应用入口
```

### 7.1.1 Flask应用初始化示例
```python
# app/__init__.py
from flask import Flask
from flask_cors import CORS
from app.config import Config

def create_app(config_class=Config):
    app = Flask(__name__)
    app.config.from_object(config_class)
    
    # 启用CORS支持
    CORS(app)
    
    # 注册Blueprint
    from app.api import datasets, reports, data
    app.register_blueprint(datasets.bp, url_prefix='/api/datasets')
    app.register_blueprint(reports.bp, url_prefix='/api/reports')
    app.register_blueprint(data.bp, url_prefix='/api/data')
    
    return app
```

### 7.2 核心服务类

#### 7.2.1 数据集服务 (DatasetService)
```python
from typing import List
from app.models.dataset import Dataset
from app.models.data_table import DataTable

class DatasetService:
    def get_datasets(self) -> List[Dataset]:
        """获取所有数据集"""
        pass
    
    def create_dataset(self, name: str, description: str, database_path: str) -> Dataset:
        """创建新数据集"""
        pass
    
    def get_tables(self, dataset_id: int) -> List[DataTable]:
        """获取数据集下的所有数据表"""
        pass
    
    def get_table_schema(self, dataset_id: int, table_name: str) -> dict:
        """获取数据表结构信息"""
        pass
```

#### 7.2.2 报表服务 (ReportService)
```python
from app.models.report import Report

class ReportService:
    def create_report(self, name: str, config: dict) -> Report:
        """创建新报表"""
        pass
    
    def get_report(self, report_id: int) -> Report:
        """获取报表详情"""
        pass
    
    def update_report(self, report_id: int, config: dict) -> Report:
        """更新报表配置"""
        pass
    
    def delete_report(self, report_id: int) -> bool:
        """删除报表"""
        pass
    
    def render_report(self, report_id: int, params: dict) -> dict:
        """渲染报表数据"""
        pass
```

#### 7.2.3 数据服务 (DataService)
```python
class DataService:
    def execute_sql(self, dataset_id: int, sql: str, params: list) -> dict:
        """执行SQL查询"""
        pass
    
    def get_table_data(self, dataset_id: int, table_name: str, filters: list, limit: int, offset: int) -> dict:
        """获取数据表数据"""
        pass
    
    def select_dataset(self, query_params: dict, algorithm: str) -> int:
        """根据算法选择数据集"""
        pass
```

#### 7.2.4 数据集选择器 (DatasetSelector)
```python
class DatasetSelector:
    def select_by_load_balance(self, query_params: dict) -> int:
        """负载均衡算法选择数据集"""
        pass
    
    def select_by_time_partition(self, query_params: dict) -> int:
        """时间分区算法选择数据集"""
        pass
    
    def select_by_business_rule(self, query_params: dict) -> int:
        """业务规则算法选择数据集"""
        pass
    
    def select_by_performance(self, query_params: dict) -> int:
        """性能优先算法选择数据集"""
        pass
```

### 7.3 Flask API路由示例

#### 7.3.1 数据集API路由
```python
# app/api/datasets.py
from flask import Blueprint, request, jsonify
from app.services.dataset_service import DatasetService

bp = Blueprint('datasets', __name__)
service = DatasetService()

@bp.route('', methods=['GET'])
def get_datasets():
    """获取数据集列表"""
    datasets = service.get_datasets()
    return jsonify({
        'code': 200,
        'data': [ds.to_dict() for ds in datasets],
    })

@bp.route('', methods=['POST'])
def create_dataset():
    """创建数据集"""
    data = request.get_json()
    dataset = service.create_dataset(
        name=data['name'],
        description=data.get('description', ''),
        database_path=data['database_path'],
    )
    return jsonify({
        'code': 200,
        'data': dataset.to_dict(),
    }), 201

@bp.route('/<int:dataset_id>/tables', methods=['GET'])
def get_tables(dataset_id):
    """获取数据表列表"""
    tables = service.get_tables(dataset_id)
    return jsonify({
        'code': 200,
        'data': [table.to_dict() for table in tables],
    })
```

## 8. 安全设计

### 8.1 SQL注入防护
- 使用参数化查询
- SQL语句白名单验证
- 禁止危险SQL关键字（DROP, DELETE, UPDATE等）
- SQL语法验证

### 8.2 数据访问控制
- 数据集访问权限控制
- 报表访问权限控制
- 操作日志记录

### 8.3 输入验证
- 前端输入验证
- 后端参数校验
- 文件路径安全检查

## 9. 性能优化

### 9.1 数据库优化
- 为常用查询字段创建索引
- 查询结果缓存
- 分页查询优化

### 9.2 前端优化
- 组件懒加载
- 大数据量虚拟滚动
- 图表渲染优化（使用WebGL或Canvas）

### 9.3 后端优化
- 数据库连接池
- 查询结果缓存（Redis可选）
- 异步处理大数据查询

## 10. 部署方案

### 10.1 开发环境
- **后端**:
  - Python 3.8+
  - SQLite 3.x
  - Flask开发服务器（`flask run`）
- **前端**:
  - Node.js 16+
  - npm 或 yarn
  - React开发服务器（Vite或CRA）

### 10.2 生产环境
- **后端**:
  - Python应用服务器（Gunicorn推荐）
  - Flask应用配置生产模式
  - SQLite数据库文件备份策略
- **前端**:
  - React应用构建为静态文件（`npm run build`）
  - 静态文件通过Nginx或Flask静态文件服务提供
- **服务器**:
  - Nginx反向代理（可选，也可直接使用Gunicorn）
  - 日志管理
  - 进程管理（supervisor或systemd）

### 10.3 部署步骤

#### 后端部署
1. 安装Python依赖: `pip install -r requirements.txt`
2. 初始化系统数据库（运行数据库迁移脚本）
3. 配置环境变量（`.env`文件）
4. 配置数据集路径
5. 使用Gunicorn启动Flask应用:
   ```bash
   gunicorn -w 4 -b 0.0.0.0:5000 app:app
   ```

#### 前端部署
1. 安装Node.js依赖: `npm install` 或 `yarn install`
2. 构建生产版本: `npm run build` 或 `yarn build`
3. 将构建后的`dist`或`build`目录部署到静态文件服务器
4. 配置Nginx指向静态文件目录（如使用Nginx）

#### 一体化部署（Flask服务静态文件）
1. 将React构建后的静态文件复制到Flask的`static`目录
2. 配置Flask路由处理前端路由（SPA支持）
3. 使用Gunicorn启动应用

## 11. 测试计划

### 11.1 单元测试
- 数据模型测试
- 服务类测试
- 工具类测试

### 11.2 集成测试
- API接口测试
- 数据库操作测试
- 数据集选择算法测试

### 11.3 功能测试
- 报表创建流程测试
- 数据源绑定测试
- 图表渲染测试
- SQL查询测试

## 12. 后续扩展

### 12.1 功能扩展
- 支持更多图表类型（柱状图、散点图、热力图等）
- 报表模板功能
- 报表分享和协作
- 数据导出（Excel、PDF）
- 定时报表生成

### 12.2 技术扩展
- 支持更多数据库类型（MySQL、PostgreSQL等）
- 实时数据更新
- 数据可视化3D图表
- 移动端适配

## 13. 附录

### 13.1 术语表
- **数据集 (Dataset)**: 一个数据源，对应一个SQLite数据库文件
- **数据表 (DataTable)**: 数据集中的具体数据表
- **报表 (Report)**: 由多个图表组件组成的可视化报表
- **组件 (Component)**: 报表中的单个图表或控件元素
- **过滤器映射 (Filter Mapping)**: 根据过滤条件选择不同数据集的规则

### 13.2 已实现功能清单

#### 核心功能
- ✅ 报表设计器（拖拽式设计）
- ✅ 组件库（折线图、饼图、下拉列表、文本框、树图）
- ✅ 数据源绑定（固定数据源、条件数据源）
- ✅ 条件数据源配置（支持静态值和组件值）
- ✅ 数据库浏览和管理
- ✅ 报表预览功能
- ✅ 报表保存和加载

#### 数据管理
- ✅ 数据集管理（创建、查看）
- ✅ 数据表管理（创建、查看、添加字段）
- ✅ 数据管理（查看、添加）

#### 高级功能
- ✅ 组件自由拖拽
- ✅ 条件数据源动态选择
- ✅ 组件间数据交互
- ✅ 数据库动态创建和管理

### 13.3 参考文档
- **后端**:
  - Flask官方文档: https://flask.palletsprojects.com/
  - SQLite官方文档: https://www.sqlite.org/docs.html
  - Python数据库操作最佳实践
  - Gunicorn部署文档: https://gunicorn.org/
- **前端**:
  - React官方文档: https://react.dev/
  - React Router文档: https://reactrouter.com/
  - Ant Design文档: https://ant.design/
  - ECharts文档: https://echarts.apache.org/
  - react-dnd文档: https://react-dnd.github.io/react-dnd/

