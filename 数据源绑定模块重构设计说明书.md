# 数据源绑定模块重构设计说明书

## 1. 概述

### 1.1 设计目标
重构数据源绑定模块，使其能够满足三种不同的数据源绑定场景，同时简化操作流程，提高配置效率，让用户能够快速完成数据源配置。

### 1.2 设计原则
- **简化操作**：减少不必要的步骤，提供直观的配置界面
- **智能辅助**：系统自动推断和选择，减少用户手动配置
- **灵活支持**：支持简单场景和复杂场景，满足不同需求
- **即时反馈**：配置过程中实时显示预览和提示信息

## 2. 三种数据源绑定场景

### 场景1：固定数据源 - 直接选择表和字段
**适用场景**：用户明确知道要使用的数据集、数据表和字段

### 场景2：固定数据源 - 直接选择字段，表可选
**适用场景**：用户知道要使用的字段，但不确定具体表名，或希望系统自动选择最合适的表

### 场景3：条件数据源 - 配置过滤条件选择字段，表可选
**适用场景**：需要根据不同的条件动态选择不同的数据源，支持复杂的业务逻辑

## 3. 统一配置界面设计

### 3.1 界面布局

```
┌─────────────────────────────────────────┐
│  数据源配置                              │
├─────────────────────────────────────────┤
│  [固定数据源] [条件数据源] [SQL查询]    │ ← 数据源类型选择（Tab切换）
├─────────────────────────────────────────┤
│                                          │
│  数据集: [下拉选择]                      │
│                                          │
│  数据表: [下拉选择] [可选] [自动选择]   │ ← 表选择（可选）
│                                          │
│  字段映射:                               │
│    X轴字段: [下拉选择]                  │
│    Y轴字段: [下拉选择]                  │
│                                          │
│  过滤条件: [添加过滤条件]                │
│    ┌─────────────────────────────┐     │
│    │ 字段 [选择] 操作符 [选择]   │     │
│    │ 值 [输入/选择]              │     │
│    └─────────────────────────────┘     │
│                                          │
│  [预览数据] [保存配置]                   │
└─────────────────────────────────────────┘
```

### 3.2 核心组件

#### 3.2.1 数据源类型选择器
- **位置**：顶部Tab切换
- **选项**：固定数据源、条件数据源、SQL查询
- **交互**：点击切换，切换时保留已配置信息（如果兼容）

#### 3.2.2 数据集选择器
- **位置**：第一个配置项
- **功能**：选择数据集
- **交互**：下拉选择，支持搜索
- **必填**：是

#### 3.2.3 数据表选择器
- **位置**：数据集下方
- **功能**：选择数据表（可选）
- **交互**：
  - 下拉选择，支持搜索
  - 提供"自动选择"选项
  - 当选择"自动选择"时，显示提示："系统将根据字段和过滤条件自动选择最合适的表"
- **必填**：否（可选）

#### 3.2.4 字段映射配置区
- **位置**：数据表下方
- **功能**：根据图表类型显示对应的字段选择项
- **显示逻辑**：
  - 如果已选择表：显示该表的字段
  - 如果未选择表：显示所有已加载表的字段（去重）
  - 如果没有任何表：提示"请先选择数据集"
- **字段类型**：
  - 折线图：X轴字段、Y轴字段
  - 饼图：分类字段、数值字段
  - 下拉列表：选项字段
  - 文本框：关联字段
  - 树图：名称字段、数值字段、父级字段

#### 3.2.5 过滤条件配置区
- **位置**：字段映射下方
- **功能**：配置数据过滤条件
- **交互**：
  - 点击"添加过滤条件"按钮
  - 每个条件包含：字段选择、操作符选择、值输入
  - 支持删除条件
  - 支持多个条件组合（AND/OR）

#### 3.2.6 条件数据源配置区（条件数据源模式）
- **位置**：数据集下方
- **功能**：配置多个条件数据源
- **交互**：
  - 显示条件列表
  - 每个条件可配置：条件字段、操作符、值类型（静态/组件）、目标数据源
  - 支持添加/删除条件
  - 支持逻辑运算符（AND/OR）

## 4. 场景操作流程

### 4.1 场景1：固定数据源 - 直接选择表和字段

#### 操作步骤：
1. **选择数据源类型**
   - 点击"固定数据源"Tab（默认选中）

2. **选择数据集**
   - 在"数据集"下拉框中选择目标数据集
   - 系统自动加载该数据集下的所有表

3. **选择数据表**
   - 在"数据表"下拉框中选择目标数据表
   - 系统自动加载该表的字段信息

4. **配置字段映射**
   - 根据图表类型，在对应的字段下拉框中选择字段
   - 例如：折线图选择X轴字段和Y轴字段

5. **（可选）配置过滤条件**
   - 点击"添加过滤条件"
   - 选择字段、操作符、输入值
   - 可添加多个条件

6. **预览和保存**
   - 点击"预览数据"查看数据预览
   - 点击"保存配置"完成配置

#### 操作步骤数：4-6步（取决于是否配置过滤条件）

---

### 4.2 场景2：固定数据源 - 直接选择字段，表可选

#### 操作步骤：
1. **选择数据源类型**
   - 点击"固定数据源"Tab（默认选中）

2. **选择数据集**
   - 在"数据集"下拉框中选择目标数据集
   - 系统自动加载该数据集下的所有表

3. **（可选）选择数据表**
   - 如果明确知道表名，在"数据表"下拉框中选择
   - 如果不知道表名，选择"自动选择"或留空
   - 系统提示："系统将根据字段和过滤条件自动选择最合适的表"

4. **配置字段映射**
   - 根据图表类型，在对应的字段下拉框中选择字段
   - 系统显示所有已加载表的字段（去重）
   - 如果选择了表，只显示该表的字段

5. **（可选）配置过滤条件**
   - 点击"添加过滤条件"
   - 选择字段、操作符、输入值
   - **重要**：过滤条件中的字段将用于自动选择表

6. **系统自动选择表**
   - 如果未选择表，系统根据以下规则自动选择：
     - 优先选择包含所有已选择字段的表
     - 如果字段来自过滤条件，优先选择包含这些字段的表
     - 如果多个表都满足，选择包含最多字段的表
     - 如果仍然无法确定，选择第一个表

7. **预览和保存**
   - 点击"预览数据"查看数据预览（显示实际使用的表名）
   - 点击"保存配置"完成配置

#### 操作步骤数：3-5步（取决于是否手动选择表和配置过滤条件）

#### 智能提示：
- 当用户选择字段后，如果未选择表，系统显示提示："已选择字段：[字段列表]，系统将自动选择包含这些字段的表"
- 当用户配置过滤条件后，系统显示提示："过滤条件中的字段：[字段列表]，将用于自动选择表"

---

### 4.3 场景3：条件数据源 - 配置过滤条件选择字段，表可选

#### 操作步骤：
1. **选择数据源类型**
   - 点击"条件数据源"Tab

2. **配置默认数据源**
   - 在"默认数据集"下拉框中选择数据集
   - （可选）在"默认数据表"下拉框中选择表，或选择"自动选择"
   - 系统提示："当所有条件都不匹配时，使用默认数据源"

3. **配置字段映射**
   - 根据图表类型，在对应的字段下拉框中选择字段
   - 系统提示："字段配置基于默认数据源，所有条件数据源应使用相同的字段结构"

4. **添加条件数据源**
   - 点击"添加条件"按钮
   - 在弹出的条件配置区域中：
     a. **配置条件**
        - 选择"条件字段"（从默认数据源的表中选择，或从其他组件选择）
        - 选择"操作符"（=, !=, >, <, >=, <=, IN, LIKE）
        - 选择"值类型"：
          - 静态值：直接输入值
          - 组件值：选择其他组件，选择组件字段
     b. **配置目标数据源**
        - 选择"数据集"
        - （可选）选择"数据表"，或选择"自动选择"
     c. **（可选）添加多个子条件**
        - 点击"添加子条件"
        - 选择逻辑运算符（AND/OR）
        - 配置子条件
     d. **保存条件**
        - 点击"保存"按钮

5. **重复步骤4**
   - 可添加多个条件数据源
   - 系统按顺序匹配，使用第一个满足条件的数据源

6. **预览和保存**
   - 点击"预览数据"查看不同条件下的数据预览
   - 点击"保存配置"完成配置

#### 操作步骤数：5-8步（取决于条件数量和复杂度）

#### 智能提示：
- 当配置条件数据源时，系统提示："条件按顺序匹配，使用第一个满足条件的数据源"
- 当选择"自动选择表"时，系统提示："系统将根据条件字段和过滤条件自动选择最合适的表"
- 当配置组件值时，系统提示："组件值变化时，将自动重新评估条件并切换数据源"

## 5. 优化设计要点

### 5.1 简化操作流程

#### 5.1.1 智能默认值
- 数据源类型默认选择"固定数据源"
- 字段映射根据图表类型自动显示对应的字段选择项
- 操作符默认选择"="

#### 5.1.2 快速配置模式
- 提供"快速配置"按钮，一键完成基础配置：
  - 自动选择第一个数据集
  - 自动选择第一个表
  - 自动选择前N个字段（根据图表类型）

#### 5.1.3 配置模板
- 提供常用配置模板：
  - "简单配置"：只选择数据集和字段
  - "标准配置"：选择数据集、表、字段
  - "高级配置"：包含过滤条件和条件数据源

### 5.2 实时反馈

#### 5.2.1 配置状态提示
- 显示当前配置的完整性：
  - ✅ 数据集已选择
  - ✅ 字段已配置
  - ⚠️ 表未选择（将自动选择）
  - ⚠️ 过滤条件未配置

#### 5.2.2 数据预览
- 提供"预览数据"功能：
  - 显示实际使用的表名（如果是自动选择的）
  - 显示数据样本（前10条）
  - 显示字段映射结果
  - 显示过滤条件效果

#### 5.2.3 错误提示
- 实时验证配置：
  - 必填项未填写时提示
  - 字段类型不匹配时提示
  - 表不存在时提示
  - 条件配置错误时提示

### 5.3 智能辅助

#### 5.3.1 字段推荐
- 根据图表类型推荐合适的字段：
  - 折线图：推荐日期/时间字段作为X轴，数值字段作为Y轴
  - 饼图：推荐文本字段作为分类，数值字段作为数值
  - 树图：推荐有层级关系的字段

#### 5.3.2 表推荐
- 当选择"自动选择"时，显示推荐的表：
  - 根据已选择的字段推荐
  - 根据过滤条件推荐
  - 显示推荐理由

#### 5.3.3 条件推荐
- 在条件数据源配置中：
  - 根据已配置的组件推荐条件
  - 根据数据源结构推荐条件字段

### 5.4 配置保存和恢复

#### 5.4.1 配置保存
- 保存完整的配置信息：
  - 数据源类型
  - 数据集ID
  - 表名（如果选择了）
  - 字段映射
  - 过滤条件
  - 条件数据源配置（如果是条件数据源）

#### 5.4.2 配置恢复
- 加载已保存的配置：
  - 自动填充所有配置项
  - 恢复表选择状态
  - 恢复过滤条件
  - 恢复条件数据源配置

## 6. 技术实现要点

### 6.1 前端实现

#### 6.1.1 组件结构
```
DataSourceConfigPanel
├── DataSourceTypeSelector (Tab切换)
├── DatasetSelector (数据集选择)
├── TableSelector (表选择，可选)
├── FieldMappingConfig (字段映射配置)
├── FilterConditionConfig (过滤条件配置)
├── ConditionalSourceConfig (条件数据源配置，条件数据源模式)
├── DataPreview (数据预览)
└── ActionButtons (保存/取消)
```

#### 6.1.2 状态管理
- 使用React Hooks管理配置状态
- 实时同步配置到组件
- 支持配置验证和错误提示

#### 6.1.3 数据加载
- 懒加载：按需加载表和字段信息
- 缓存机制：已加载的数据缓存，避免重复请求
- 异步加载：不阻塞用户操作

### 6.2 后端实现

#### 6.2.1 自动表选择算法
- 根据字段名匹配表
- 根据过滤条件匹配表
- 优先级：完全匹配 > 部分匹配 > 默认表

#### 6.2.2 数据查询优化
- 支持可选的table_name参数
- 当table_name为空时，自动选择表
- 返回实际使用的表名

### 6.3 数据流

```
用户操作
  ↓
前端状态更新
  ↓
配置验证
  ↓
（如果需要）后端自动选择表
  ↓
数据预览
  ↓
保存配置
```

## 7. 用户体验优化

### 7.1 界面优化
- 使用清晰的视觉层次
- 重要信息突出显示
- 可选项明确标注
- 提供操作提示和帮助信息

### 7.2 交互优化
- 减少点击次数
- 提供快捷键支持
- 支持拖拽排序（条件数据源）
- 支持批量操作

### 7.3 性能优化
- 异步加载数据，不阻塞界面
- 使用虚拟滚动（如果数据量大）
- 缓存常用数据
- 优化网络请求

## 8. 测试场景

### 8.1 场景1测试
- 测试完整的选择表和字段流程
- 测试字段映射的正确性
- 测试过滤条件的有效性

### 8.2 场景2测试
- 测试自动选择表的准确性
- 测试基于字段的自动选择
- 测试基于过滤条件的自动选择
- 测试字段和过滤条件组合的自动选择

### 8.3 场景3测试
- 测试条件数据源的配置流程
- 测试条件的匹配逻辑
- 测试默认数据源的fallback
- 测试组件值的动态更新

## 9. 后续优化方向

### 9.1 配置模板
- 提供常用配置模板
- 支持用户自定义模板
- 支持模板分享

### 9.2 配置向导
- 提供分步配置向导
- 适合新手用户
- 提供详细说明和示例

### 9.3 配置历史
- 保存配置历史
- 支持配置回滚
- 支持配置对比

### 9.4 批量配置
- 支持批量选择组件配置数据源
- 支持配置复制和粘贴
- 支持配置导入和导出

## 10. 总结

本设计通过统一配置界面、智能辅助、实时反馈等方式，简化了数据源配置流程，提高了配置效率。三种场景都能够在最少的操作步骤内完成配置，同时保持了足够的灵活性以满足复杂需求。

关键优化点：
1. **表选择可选化**：支持自动选择，减少用户决策负担
2. **字段优先配置**：允许先配置字段，再自动选择表
3. **智能推荐**：系统根据上下文推荐合适的配置
4. **实时预览**：配置过程中实时查看效果
5. **统一界面**：三种场景使用统一的配置界面，降低学习成本

