# 条件数据源配置说明

## 概述

条件数据源功能允许根据不同的条件动态选择不同的数据源。在配置条件数据源时，有两个重要的字段需要理解：**条件字段**和**组件字段**。

---

## 字段说明

### 1. 条件字段 (field)

**含义**：
- 条件字段是用于**数据查询过滤**的数据库字段名
- 当条件匹配时，系统会使用这个字段来过滤查询的数据
- 这是一个**可选字段**，如果留空，条件评估将基于值比较，而不进行数据库字段过滤

**使用场景**：
- 当你需要在匹配条件后，进一步根据数据库字段过滤数据时使用
- 例如：当地区="north"时，不仅选择数据集1，还要过滤出该数据集中`region`字段等于"north"的记录

**配置方法**：
1. 在条件数据源配置窗口中，找到"条件字段"输入框
2. 输入数据库表中的字段名（例如：`region`、`category`、`status`等）
3. 如果不使用字段过滤，可以留空

**示例**：
```
条件字段: region
操作符: =
值类型: 静态值
静态值: north
```
这表示：当`region`字段的值等于"north"时，匹配此条件。

---

### 2. 组件字段 (componentField)

**含义**：
- 组件字段用于指定从**来源组件**的哪个属性或字段获取值
- 只有当"值类型"选择为"组件值"时，此字段才会显示
- 用于从其他组件（如下拉列表、文本框等）获取当前值作为条件判断的依据

**使用场景**：
- 当条件值需要从其他组件动态获取时使用
- 例如：图表A的数据源根据下拉列表B的选中值来决定

**配置方法**：
1. 首先选择"值类型"为"组件值"
2. 在"来源组件"下拉框中选择要获取值的组件
3. 在"组件字段"输入框中输入要获取的字段名

**常见的组件字段名**：
- **下拉列表 (dropdown)**：
  - `value` - 当前选中的值（推荐使用）
  - `selectedValue` - 选中的值（别名，与value功能完全相同，为了兼容性保留）
  
  **说明**：`value` 和 `selectedValue` 对于下拉列表组件来说功能完全相同，都表示当前选中的值。系统会将它们视为同一个字段，都从组件的 `props.value` 中获取值。建议使用 `value`，因为它更简洁且是标准命名。
  
- **文本框 (text_input)**：
  - `value` - 当前输入的文本值
  
- **树图 (tree_chart)**：
  - `selectedNodePath` - 选中节点的完整路径数组（推荐用于需要完整路径的场景）
    - 返回值类型：数组，例如 `['根节点', '节点1', '节点2']`
    - 用途：当需要根据完整的节点路径进行条件匹配时使用
    - 注意：数组比较需要使用 `IN` 操作符或转换为字符串进行比较
  - `selectedNode` - 选中路径的最后一个节点名称（推荐用于大多数场景）
    - 返回值类型：字符串，例如 `'节点2'`
    - 用途：当只需要根据选中的节点名称进行条件匹配时使用
    - 这是最常用的字段，因为通常只需要知道用户选择了哪个节点
  - `value` - 选中路径的最后一个节点名称（与 `selectedNode` 功能相同）
    - 返回值类型：字符串，例如 `'节点2'`
    - 用途：与 `selectedNode` 相同，为了保持一致性而提供的别名
  
  **说明**：
  - 树图组件支持用户点击节点进行选择，选中的节点会被高亮显示
  - 选择节点后，系统会记录从根节点到选中节点的完整路径
  - `selectedNodePath` 返回完整路径数组，适合需要精确匹配路径的场景
  - `selectedNode` 或 `value` 返回最后一个节点名称，适合大多数只需要节点名称的场景
  - **推荐使用 `selectedNode` 或 `value`**，因为它们返回简单的字符串值，更容易进行条件匹配
  
- **图表组件**：
  - `selectedData` - 选中的数据点
  - `filterValue` - 过滤值

**示例**：
```
值类型: 组件值
来源组件: component-12345678 (下拉列表)
组件字段: value
操作符: =
```
这表示：从ID为`component-12345678`的下拉列表组件中获取`value`字段的值，用于条件判断。

---

## 完整配置示例

### 示例1：静态条件（不使用条件字段）

**场景**：根据固定的地区值选择不同的数据集

**配置**：
```
条件字段: （留空）
操作符: =
值类型: 静态值
静态值: north
数据源: 数据集1 / 销售数据-北方
```

**说明**：
- 当条件值等于"north"时，使用数据集1
- 不使用条件字段，所以不会对数据进行字段过滤

---

### 示例2：静态条件（使用条件字段）

**场景**：根据地区值选择数据集，并且只显示该地区的数据

**配置**：
```
条件字段: region
操作符: =
值类型: 静态值
静态值: north
数据源: 数据集1 / 销售数据
```

**说明**：
- 当`region`字段的值等于"north"时，匹配此条件
- 使用数据集1，并且查询时会过滤`region='north'`的记录

---

### 示例3：动态条件（组件值）- 如何区分不同数据源

**场景**：图表的数据源根据下拉列表的选中值动态切换

**问题**：当组件字段选择"value"时，如何知道value取多少时使用数据源1，何时使用数据源2？

**解决方案**：需要为每个条件配置"目标值"，明确指定匹配条件。

**配置步骤**：

1. **配置下拉列表组件**：
   - 组件类型：下拉列表
   - 数据源：包含选项的数据表（例如：产品表，包含"产品A"、"产品B"等选项）
   - 字段绑定：选项字段

2. **配置第一个条件数据源**：
   ```
   条件字段: （留空）
   操作符: =
   值类型: 组件值
   来源组件: [选择下拉列表组件]
   组件字段: value
   值匹配方式: 使用固定值匹配（推荐）
   目标值来源: 手动输入
   目标值: 产品A
   数据源: 数据集1 / 产品A数据
   ```

3. **配置第二个条件数据源**：
   ```
   条件字段: （留空）
   操作符: =
   值类型: 组件值
   来源组件: [选择同一个下拉列表组件]
   组件字段: value
   值匹配方式: 使用固定值匹配
   目标值来源: 手动输入
   目标值: 产品B
   数据源: 数据集2 / 产品B数据
   ```

**工作原理**：
1. 系统从下拉列表组件的`value`属性获取当前选中的值（例如："产品A"）
2. 系统按顺序检查每个条件：
   - 条件1：比较组件的value（"产品A"）和目标值（"产品A"）→ 匹配 → 使用数据集1
   - 条件2：比较组件的value（"产品A"）和目标值（"产品B"）→ 不匹配 → 继续检查
3. 如果用户选择"产品B"：
   - 条件1：比较组件的value（"产品B"）和目标值（"产品A"）→ 不匹配 → 继续检查
   - 条件2：比较组件的value（"产品B"）和目标值（"产品B"）→ 匹配 → 使用数据集2

**关键点**：
- **必须为每个条件配置不同的目标值**
- 目标值应该与下拉列表组件中实际可能的值一致
- 如果使用"从数据源选择"，目标值会从来源组件的数据源中获取

---

### 示例4：复杂条件（组件值 + 条件字段）

**场景**：根据下拉列表的值选择数据集，并且根据该值过滤数据

**配置**：
```
条件字段: product_category
操作符: =
值类型: 组件值
来源组件: [选择下拉列表组件]
组件字段: value
数据源: 数据集1 / 产品数据
```

**说明**：
- 从下拉列表获取选中的值（例如："电子产品"）
- 使用数据集1，并且查询时会过滤`product_category='电子产品'`的记录

---

### 示例5：树图作为源组件（使用节点名称）

**场景**：饼图的数据源根据树图中选中的节点动态切换

**配置步骤**：

1. **配置树图组件**：
   - 组件类型：树图
   - 数据源：包含层级结构的数据表
   - 字段绑定：名称字段和数值字段

2. **配置第一个条件数据源**：
   ```
   条件字段: （留空）
   操作符: =
   值类型: 组件值
   来源组件: [选择树图组件]
   组件字段: selectedNode（或 value）
   值匹配方式: 使用固定值匹配
   目标值来源: 手动输入
   目标值: 节点A
   数据源: 数据集1 / 节点A数据
   ```

3. **配置第二个条件数据源**：
   ```
   条件字段: （留空）
   操作符: =
   值类型: 组件值
   来源组件: [选择同一个树图组件]
   组件字段: selectedNode（或 value）
   值匹配方式: 使用固定值匹配
   目标值来源: 手动输入
   目标值: 节点B
   数据源: 数据集2 / 节点B数据
   ```

**工作原理**：
1. 用户在树图中点击某个节点（例如："节点A"）
2. 系统从树图组件的`selectedNode`属性获取选中节点的名称（"节点A"）
3. 系统按顺序检查每个条件：
   - 条件1：比较树图的selectedNode（"节点A"）和目标值（"节点A"）→ 匹配 → 使用数据集1
   - 条件2：比较树图的selectedNode（"节点A"）和目标值（"节点B"）→ 不匹配 → 继续检查
4. 如果用户选择"节点B"：
   - 条件1：比较树图的selectedNode（"节点B"）和目标值（"节点A"）→ 不匹配 → 继续检查
   - 条件2：比较树图的selectedNode（"节点B"）和目标值（"节点B"）→ 匹配 → 使用数据集2

**关键点**：
- **推荐使用 `selectedNode` 或 `value`**，它们返回选中节点的名称（字符串），便于条件匹配
- 目标值应该与树图中实际可能选中的节点名称一致
- 树图选择节点后会自动高亮显示，选中的节点名称会更新到组件的`props.selectedNode`中

---

### 示例6：树图作为源组件（使用完整路径）

**场景**：需要根据树图的完整路径进行精确匹配

**配置**：
```
条件字段: （留空）
操作符: =
值类型: 组件值
来源组件: [选择树图组件]
组件字段: selectedNodePath
值匹配方式: 使用固定值匹配
目标值来源: 手动输入
目标值: ["根节点", "节点1", "节点2"]（需要输入JSON格式的数组字符串）
数据源: 数据集1 / 特定路径数据
```

**说明**：
- `selectedNodePath` 返回完整的路径数组，例如：`['根节点', '节点1', '节点2']`
- 适合需要精确匹配完整路径的场景
- 注意：数组比较需要使用 `IN` 操作符或转换为字符串进行比较
- **不推荐使用**，除非确实需要完整路径匹配，因为数组比较较为复杂

**推荐做法**：
- 大多数场景下，使用 `selectedNode` 或 `value` 即可满足需求
- 它们返回简单的字符串值，更容易进行条件匹配和配置

---

## 配置流程

### 步骤1：选择数据源类型
在属性面板中，选择"条件数据源"类型。

### 步骤2：打开配置窗口
点击"配置条件数据源"按钮，打开配置Modal窗口。

### 步骤3：配置默认数据源
设置当没有条件匹配时使用的默认数据源：
- 选择默认数据集
- 选择默认数据表

### 步骤4：添加条件数据源
1. 点击"添加条件数据源"按钮
2. 配置条件：
   - **条件字段**（可选）：输入数据库字段名，或留空
   - **操作符**：选择比较操作符（=, !=, >, <, >=, <=, IN, LIKE）
   - **值类型**：选择"静态值"或"组件值"
   - **静态值/组件配置**：
     - 如果选择"静态值"：输入固定的值
     - 如果选择"组件值"：
       - 选择来源组件
       - 输入组件字段名（如：`value`）
3. 配置对应的数据源：
   - 选择数据集
   - 选择数据表

### 步骤5：添加更多条件（可选）
可以添加多个条件，系统会按顺序匹配第一个满足的条件。

### 步骤6：保存配置
点击"关闭"按钮保存配置。

---

## 注意事项

1. **条件字段是可选的**：
   - 如果不需要根据数据库字段过滤，可以留空
   - 如果留空，条件评估仅基于值比较

2. **组件字段的命名**：
   - 不同组件类型可能有不同的字段名
   - 建议查看组件文档或使用常见的字段名（如`value`）

3. **条件匹配顺序**：
   - 系统按条件配置的顺序依次匹配
   - 一旦找到匹配的条件，就使用对应的数据源，不再继续匹配

4. **默认数据源**：
   - 建议始终配置默认数据源
   - 当所有条件都不匹配时，使用默认数据源

5. **组件值的获取**：
   - 确保来源组件已经正确配置了数据源
   - 组件字段名必须与组件实际使用的属性名一致

---

## 常见问题

### Q1: 条件字段和组件字段有什么区别？

**A**: 
- **条件字段**：用于在数据库查询时进行字段过滤（可选）
- **组件字段**：用于指定从来源组件的哪个属性获取值（仅当值类型为"组件值"时使用）

### Q2: 什么时候需要填写条件字段？

**A**: 当你需要在匹配条件后，进一步根据数据库字段过滤数据时填写。如果只是根据值选择不同的数据集，可以留空。

### Q3: 组件字段应该填什么？

**A**: 根据来源组件的类型填写：
- 下拉列表、文本框：通常填写`value`（推荐）或`selectedValue`（下拉列表的别名）
- 树图：通常填写`selectedNode`或`value`（返回选中节点的名称），如果需要完整路径则填写`selectedNodePath`
- 图表组件：可能需要填写`selectedData`或其他特定字段
- 如果不确定，可以查看组件的文档或尝试常见的字段名

**注意**：
- 对于下拉列表组件，`value`和`selectedValue`功能完全相同，都表示当前选中的值。系统会将它们视为同一个字段处理。
- 对于树图组件，`selectedNode`和`value`功能完全相同，都返回选中路径的最后一个节点名称。`selectedNodePath`返回完整的路径数组。

### Q4: 为什么我的条件数据源不工作？

**A**: 检查以下几点：
1. 是否配置了默认数据源
2. 条件值是否正确（静态值或组件值）
3. 操作符是否合适
4. 如果使用组件值，确保来源组件已正确配置
5. 组件字段名是否正确

---

## 总结

- **条件字段**：数据库字段名，用于数据过滤（可选）
- **组件字段**：来源组件的属性名，用于获取值（仅组件值类型）

正确理解和使用这两个字段，可以创建灵活的动态数据源配置，实现复杂的数据展示逻辑。

