# 数据源绑定功能说明书

## 目录

1. [功能概述](#功能概述)
2. [数据源类型](#数据源类型)
3. [固定数据源配置](#固定数据源配置)
4. [条件数据源配置](#条件数据源配置)
5. [字段映射配置](#字段映射配置)
6. [数据预览功能](#数据预览功能)
7. [常见问题](#常见问题)
8. [最佳实践](#最佳实践)

---

## 功能概述

数据源绑定功能是报表BI系统的核心功能之一，用于将图表组件与数据源进行关联，实现数据的可视化展示。系统支持多种数据源绑定方式，满足不同复杂度的业务需求。

### 核心特性

- **多种数据源类型**：支持固定数据源和条件数据源两种类型
- **智能表选择**：支持自动选择数据表，减少手动配置
- **灵活字段映射**：根据图表类型自动显示对应的字段配置项
- **实时数据预览**：配置过程中可实时预览数据效果
- **条件动态切换**：支持根据条件动态选择不同的数据源

### 适用场景

- **简单场景**：直接选择数据集、数据表和字段
- **中等场景**：知道字段但不确定表名，让系统自动选择
- **复杂场景**：根据条件动态选择不同的数据源

---

## 数据源类型

系统支持两种数据源类型，通过属性面板顶部的Tab进行切换：

### 1. 固定数据源（table）

**特点**：
- 使用固定的数据集和数据表
- 配置简单，适合大多数场景
- 支持表名可选，系统可自动选择

**适用场景**：
- 数据源固定不变
- 明确知道要使用的表和字段
- 需要快速配置的场景

### 2. 条件数据源（conditional）

**特点**：
- 根据条件动态选择不同的数据源
- 支持多个条件配置
- 支持静态值和组件值两种条件类型

**适用场景**：
- 需要根据条件切换数据源
- 数据源依赖于其他组件的值
- 复杂的业务逻辑场景

---

## 固定数据源配置

### 配置界面

固定数据源的配置界面包含以下部分：

```
┌─────────────────────────────────────────┐
│  属性配置                                 │
├─────────────────────────────────────────┤
│  [固定数据源] [条件数据源]  ← Tab切换    │
├─────────────────────────────────────────┤
│                                          │
│  数据集: [下拉选择] ★必填                │
│                                          │
│  数据表: [下拉选择] [可选]              │
│   提示：可选，系统可自动选择             │
│                                          │
│  字段映射:                               │
│    X轴字段: [下拉选择]                  │
│    Y轴字段: [下拉选择]                  │
│                                          │
│  数据预览:                               │
│    [预览数据] 按钮                        │
│    [数据表格预览]                        │
└─────────────────────────────────────────┘
```

### 配置步骤

#### 步骤1：选择数据集

1. 在属性面板的"数据集"下拉框中选择目标数据集
2. 系统自动加载该数据集下的所有数据表
3. 如果数据集列表为空，请先在数据库浏览页面创建数据集

**注意**：数据集为必填项，必须选择后才能继续配置。

#### 步骤2：选择数据表（可选）

**方式一：手动选择表**
1. 在"数据表"下拉框中选择目标数据表
2. 系统自动加载该表的字段信息
3. 字段映射区域会显示该表的可用字段

**方式二：自动选择表**
1. 不选择数据表，或清空已选择的表
2. 系统会根据以下规则自动选择最合适的表：
   - 优先选择包含所有已选择字段的表
   - 如果多个表都满足，选择包含最多字段的表
   - 如果仍然无法确定，选择第一个表
3. 系统会在数据预览时显示实际使用的表名

**智能提示**：
- 当未选择表时，系统会显示提示："系统将根据字段自动选择最合适的表"
- 当选择了字段后，系统会显示："已选择字段：[字段列表]，系统将自动选择包含这些字段的表"

#### 步骤3：配置字段映射

根据图表类型，系统会显示对应的字段配置项：

| 图表类型 | 字段配置项 | 说明 |
|---------|-----------|------|
| 折线图 | X轴字段、Y轴字段 | X轴通常为分类字段，Y轴为数值字段 |
| 饼图 | 分类字段、数值字段 | 分类字段用于分组，数值字段用于计算 |
| 下拉列表 | 选项字段 | 用于填充下拉选项 |
| 文本框 | 无 | 文本框通常不需要字段映射 |
| 树图 | 名称字段、数值字段 | 名称字段用于节点显示，数值字段用于节点值 |

**配置方法**：
1. 在对应的字段下拉框中选择字段
2. 如果已选择表，下拉框只显示该表的字段
3. 如果未选择表，下拉框显示所有已加载表的字段（去重）

#### 步骤4：预览数据（可选）

1. 点击"预览数据"按钮
2. 系统会显示：
   - 实际使用的表名（如果是自动选择的）
   - 数据样本（前10条记录）
   - 字段映射结果

**注意**：预览功能可以帮助验证配置是否正确，建议在保存前进行预览。

### 配置示例

#### 示例1：折线图 - 完整配置

**场景**：创建一个折线图，显示销售数据的时间趋势

**配置步骤**：
1. 选择数据集：`销售数据集`
2. 选择数据表：`销售记录表`
3. 配置字段映射：
   - X轴字段：`日期`
   - Y轴字段：`销售额`
4. 点击"预览数据"查看效果

#### 示例2：饼图 - 自动选表

**场景**：创建一个饼图，显示各地区的销售占比，但不确定表名

**配置步骤**：
1. 选择数据集：`销售数据集`
2. 不选择数据表（留空）
3. 配置字段映射：
   - 分类字段：`地区`
   - 数值字段：`销售额`
4. 系统自动选择包含"地区"和"销售额"字段的表
5. 点击"预览数据"查看实际使用的表名

---

## 条件数据源配置

### 功能说明

条件数据源允许根据不同的条件动态选择不同的数据源。当条件匹配时，使用对应的数据源；当所有条件都不匹配时，使用默认数据源。

### 配置界面

条件数据源的配置通过独立的Modal窗口进行，提供更大的配置空间：

```
┌─────────────────────────────────────────┐
│  条件数据源配置                    [×]   │
├─────────────────────────────────────────┤
│                                          │
│  ┌─ 默认数据源 ───────────────────┐    │
│  │ 默认数据集: [下拉选择]         │    │
│  │ 默认数据表: [下拉选择] [可选]  │    │
│  └────────────────────────────────┘    │
│                                          │
│  ┌─ 条件数据源 ───────────────────┐    │
│  │ 条件 1                          │    │
│  │   ┌─ 子条件 1 ─────────────┐   │    │
│  │   │ 条件字段: [选择/留空]  │   │    │
│  │   │ 操作符: [=]            │   │    │
│  │   │ 值类型: ○静态值 ○组件值│   │    │
│  │   │ 静态值: [输入]        │   │    │
│  │   └───────────────────────┘   │    │
│  │   [添加子条件]                  │    │
│  │   逻辑运算符: ○AND ○OR         │    │
│  │   数据集: [下拉选择]            │    │
│  │   数据表: [下拉选择] [可选]     │    │
│  │   [删除]                        │    │
│  └────────────────────────────────┘    │
│                                          │
│  [添加条件数据源]                       │
│                                          │
│  [取消]  [保存]                          │
└─────────────────────────────────────────┘
```

### 配置步骤

#### 步骤1：打开配置窗口

1. 在属性面板中选择"条件数据源"Tab
2. 点击"配置条件数据源"按钮
3. 打开条件数据源配置Modal窗口

#### 步骤2：配置默认数据源

默认数据源是当所有条件都不匹配时使用的数据源，建议始终配置。

1. **选择默认数据集**
   - 在"默认数据集"下拉框中选择数据集
   - 系统自动加载该数据集下的所有表

2. **选择默认数据表（可选）**
   - 如果明确知道表名，在"默认数据表"下拉框中选择
   - 如果不知道表名，可以留空，系统会根据字段自动选择

**提示**：默认数据源用于字段映射配置，所有条件数据源应使用相同的字段结构。

#### 步骤3：配置字段映射

在属性面板的"字段映射"区域配置字段：

1. 根据图表类型选择对应的字段
2. 字段配置基于默认数据源的表结构
3. 所有条件数据源应使用相同的字段映射

**注意**：如果条件数据源需要不同的字段映射，可以在条件数据源配置中单独配置。

#### 步骤4：添加条件数据源

1. **点击"添加条件数据源"按钮**

2. **配置条件**
   
   **a. 添加子条件**
   - 点击"添加子条件"按钮
   - 每个子条件包含以下配置项：
   
   **条件字段（可选）**：
   - 用于数据查询过滤的数据库字段名
   - 如果留空，条件评估仅基于值比较，不进行数据库字段过滤
   - 如果填写，当条件匹配时，会使用该字段过滤数据
   
   **操作符**：
   - `=`：等于
   - `!=`：不等于
   - `>`：大于
   - `<`：小于
   - `>=`：大于等于
   - `<=`：小于等于
   - `IN`：包含在列表中
   - `LIKE`：模糊匹配
   
   **值类型**：
   - **静态值**：直接输入固定的值
   - **组件值**：从其他组件获取值
   
   **静态值配置**：
   - 选择"静态值"后，在"静态值"输入框中输入值
   - 例如：`north`、`100`、`2024-01-01`等
   
   **组件值配置**：
   - 选择"组件值"后，需要配置以下项：
     - **来源组件**：选择提供值的组件（下拉列表、文本框、图表等）
     - **组件字段**：选择从组件获取值的字段
       - 下拉列表：`value`（当前选中值）
       - 文本框：`value`（输入值）
       - 树图：`selectedNode`（选中节点名称，推荐）或 `selectedNodePath`（完整路径数组）
       - 图表：`selectedData`（选中的数据）
     - **目标值来源**：
       - **手动输入**：直接输入要匹配的值
       - **从数据源选择**：从来源组件的数据源中选择值
     - **目标值**：输入或选择要匹配的值
   
   **b. 配置逻辑运算符**
   - 当有多个子条件时，选择逻辑运算符：
     - **AND**：所有子条件都满足
     - **OR**：任一子条件满足
   
   **c. 配置目标数据源**
   - **数据集**：选择当条件匹配时使用的数据集
   - **数据表**：选择数据表（可选，系统可自动选择）
   - **字段映射**（可选）：如果条件数据源需要不同的字段映射，可以单独配置

3. **保存条件**
   - 配置完成后，条件会自动保存
   - 可以继续添加更多条件数据源

#### 步骤5：条件匹配规则

系统按以下规则匹配条件：

1. **按顺序匹配**：系统按条件配置的顺序依次检查
2. **第一个匹配**：一旦找到匹配的条件，就使用对应的数据源，不再继续匹配
3. **默认数据源**：如果所有条件都不匹配，使用默认数据源

**匹配逻辑**：
- 对于每个条件，评估所有子条件
- 根据逻辑运算符（AND/OR）组合子条件结果
- 如果条件匹配，使用对应的数据源

### 配置示例

#### 示例1：静态条件 - 根据地区选择数据源

**场景**：根据地区值选择不同的数据集

**配置步骤**：

1. **配置默认数据源**
   - 默认数据集：`通用数据集`
   - 默认数据表：`通用数据表`

2. **添加条件数据源1**
   - 条件字段：（留空）
   - 操作符：`=`
   - 值类型：静态值
   - 静态值：`north`
   - 数据集：`北方数据集`
   - 数据表：`北方销售数据`

3. **添加条件数据源2**
   - 条件字段：（留空）
   - 操作符：`=`
   - 值类型：静态值
   - 静态值：`south`
   - 数据集：`南方数据集`
   - 数据表：`南方销售数据`

**工作原理**：
- 当条件值等于"north"时，使用北方数据集
- 当条件值等于"south"时，使用南方数据集
- 其他情况使用默认数据源

#### 示例2：组件值条件 - 根据下拉列表选择数据源

**场景**：图表的数据源根据下拉列表的选中值动态切换

**配置步骤**：

1. **配置下拉列表组件**
   - 组件类型：下拉列表
   - 数据源：包含选项的数据表（例如：产品表）
   - 字段绑定：选项字段

2. **配置默认数据源**
   - 默认数据集：`默认数据集`
   - 默认数据表：`默认数据表`

3. **添加条件数据源1**
   - 条件字段：（留空）
   - 操作符：`=`
   - 值类型：组件值
   - 来源组件：`[选择下拉列表组件]`
   - 组件字段：`value`
   - 目标值来源：手动输入
   - 目标值：`产品A`
   - 数据集：`产品A数据集`
   - 数据表：`产品A数据`

4. **添加条件数据源2**
   - 条件字段：（留空）
   - 操作符：`=`
   - 值类型：组件值
   - 来源组件：`[选择同一个下拉列表组件]`
   - 组件字段：`value`
   - 目标值来源：手动输入
   - 目标值：`产品B`
   - 数据集：`产品B数据集`
   - 数据表：`产品B数据`

**工作原理**：
1. 系统从下拉列表组件的`value`属性获取当前选中的值
2. 系统按顺序检查每个条件：
   - 条件1：比较组件的value和目标值"产品A" → 匹配 → 使用产品A数据集
   - 条件2：比较组件的value和目标值"产品B" → 匹配 → 使用产品B数据集
3. 当用户在下拉列表中选择不同值时，系统自动重新评估条件并切换数据源

#### 示例3：条件字段过滤 - 根据字段值过滤数据

**场景**：根据地区值选择数据集，并且只显示该地区的数据

**配置步骤**：

1. **配置默认数据源**
   - 默认数据集：`销售数据集`
   - 默认数据表：`销售数据表`

2. **添加条件数据源**
   - 条件字段：`region`（地区字段）
   - 操作符：`=`
   - 值类型：静态值
   - 静态值：`north`
   - 数据集：`销售数据集`
   - 数据表：`销售数据表`

**工作原理**：
- 当`region`字段的值等于"north"时，匹配此条件
- 使用销售数据集，并且查询时会过滤`region='north'`的记录
- 只显示北方地区的数据

#### 示例4：多子条件组合

**场景**：需要同时满足多个条件

**配置步骤**：

1. **添加条件数据源**
   - 逻辑运算符：`AND`
   - 子条件1：
     - 条件字段：`region`
     - 操作符：`=`
     - 值类型：静态值
     - 静态值：`north`
   - 子条件2：
     - 条件字段：`year`
     - 操作符：`=`
     - 值类型：静态值
     - 静态值：`2024`
   - 数据集：`北方2024数据集`
   - 数据表：`北方2024数据`

**工作原理**：
- 当`region='north'` AND `year='2024'`时，匹配此条件
- 使用北方2024数据集

---

## 字段映射配置

### 字段映射说明

字段映射是将数据表中的字段映射到图表组件需要的字段。不同的图表类型需要不同的字段映射。

### 字段映射规则

| 图表类型 | 必需字段 | 可选字段 | 说明 |
|---------|---------|---------|------|
| 折线图 | X轴字段、Y轴字段 | - | X轴通常为分类字段（如日期、类别），Y轴为数值字段 |
| 饼图 | 分类字段、数值字段 | - | 分类字段用于分组，数值字段用于计算占比 |
| 下拉列表 | 选项字段 | - | 用于填充下拉选项的字段 |
| 文本框 | - | - | 文本框通常不需要字段映射 |
| 树图 | 名称字段、数值字段 | - | 名称字段用于节点显示，数值字段用于节点值 |

### 字段选择规则

1. **已选择表**：只显示该表的字段
2. **未选择表**：显示所有已加载表的字段（去重）
3. **条件数据源**：基于默认数据源的表结构显示字段

### 字段类型说明

系统支持以下字段类型：

- **文本类型**：`TEXT`、`VARCHAR`、`CHAR`等
- **数值类型**：`INTEGER`、`REAL`、`NUMERIC`等
- **日期类型**：`DATE`、`DATETIME`、`TIMESTAMP`等
- **布尔类型**：`BOOLEAN`等

**注意**：选择字段时，建议根据字段类型选择合适的用途：
- 文本类型：适合作为分类字段、X轴字段
- 数值类型：适合作为数值字段、Y轴字段
- 日期类型：适合作为X轴字段（时间序列）

---

## 数据预览功能

### 功能说明

数据预览功能允许在配置过程中实时查看数据效果，帮助验证配置是否正确。

### 使用方法

1. **配置数据源**：完成数据集、数据表、字段映射的配置
2. **点击预览按钮**：在属性面板的"数据预览"区域，点击"预览数据"按钮
3. **查看预览结果**：
   - 实际使用的表名（如果是自动选择的）
   - 数据样本（前10条记录）
   - 字段映射结果

### 预览信息说明

**表名显示**：
- 如果手动选择了表，显示选择的表名
- 如果自动选择了表，显示"自动选择"和实际使用的表名

**数据样本**：
- 显示前10条记录
- 显示所有字段的值
- 可以滚动查看更多数据

**字段映射验证**：
- 可以验证字段映射是否正确
- 可以查看实际的数据值

### 注意事项

1. **预览限制**：预览只显示前10条记录，实际数据可能更多
2. **性能考虑**：预览会执行实际的数据查询，如果数据量大可能较慢
3. **条件数据源**：条件数据源模式下，预览使用默认数据源的数据

---

## 常见问题

### Q1: 如何选择合适的数据源类型？

**A**: 
- **固定数据源**：适用于数据源固定不变的场景，配置简单
- **条件数据源**：适用于需要根据条件动态切换数据源的场景，配置相对复杂

### Q2: 什么时候可以不选择数据表？

**A**: 
- 当你知道要使用的字段，但不确定表名时
- 当希望系统自动选择最合适的表时
- 系统会根据已选择的字段自动选择包含这些字段的表

### Q3: 条件数据源中的"条件字段"和"组件字段"有什么区别？

**A**: 
- **条件字段**：用于数据查询过滤的数据库字段名（可选），如果填写，当条件匹配时会使用该字段过滤数据
- **组件字段**：用于指定从来源组件的哪个属性获取值（仅当值类型为"组件值"时使用）

### Q4: 如何配置组件值条件？

**A**: 
1. 选择"值类型"为"组件值"
2. 选择"来源组件"（提供值的组件）
3. 选择"组件字段"（从组件获取值的字段）
4. 配置"目标值"（要匹配的值）
5. 系统会比较组件的当前值和目标值，如果匹配则使用对应的数据源

### Q5: 条件数据源的条件匹配顺序是什么？

**A**: 
- 系统按条件配置的顺序依次检查
- 一旦找到匹配的条件，就使用对应的数据源，不再继续匹配
- 如果所有条件都不匹配，使用默认数据源

### Q6: 为什么我的字段下拉框是空的？

**A**: 
- 检查是否已选择数据集
- 检查是否已加载数据表（可能需要等待加载完成）
- 检查数据表是否包含字段
- 如果未选择表，系统会显示所有已加载表的字段（去重）

### Q7: 如何验证配置是否正确？

**A**: 
- 使用"预览数据"功能查看数据效果
- 检查字段映射是否正确
- 检查数据是否符合预期
- 对于条件数据源，可以测试不同条件下的数据源切换

### Q8: 条件数据源支持哪些操作符？

**A**: 
- `=`：等于
- `!=`：不等于
- `>`：大于
- `<`：小于
- `>=`：大于等于
- `<=`：小于等于
- `IN`：包含在列表中
- `LIKE`：模糊匹配

### Q9: 如何配置多个子条件？

**A**: 
1. 在条件数据源配置中，点击"添加子条件"按钮
2. 配置每个子条件
3. 选择逻辑运算符（AND/OR）
4. 系统会根据逻辑运算符组合子条件结果

### Q10: 条件数据源中的字段映射可以不同吗？

**A**: 
- 默认情况下，所有条件数据源使用相同的字段映射（基于默认数据源）
- 如果条件数据源需要不同的字段映射，可以在条件数据源配置中单独配置
- 建议保持字段映射一致，除非确实需要不同的映射

---

## 最佳实践

### 1. 数据源选择

- **优先使用固定数据源**：如果数据源固定不变，使用固定数据源，配置简单
- **合理使用条件数据源**：只有在需要动态切换数据源时才使用条件数据源

### 2. 表选择策略

- **明确知道表名**：直接选择表，配置更精确
- **不确定表名**：不选择表，让系统自动选择，减少配置负担
- **字段优先**：可以先配置字段，再让系统自动选择表

### 3. 字段映射配置

- **选择合适的字段类型**：根据图表类型选择合适的字段
- **字段命名规范**：建议使用有意义的字段名，便于识别
- **验证字段映射**：使用预览功能验证字段映射是否正确

### 4. 条件数据源配置

- **始终配置默认数据源**：确保所有情况下都有数据源可用
- **条件顺序很重要**：将最具体的条件放在前面，最通用的条件放在后面
- **合理使用条件字段**：只有在需要字段过滤时才填写条件字段
- **测试不同条件**：配置完成后，测试不同条件下的数据源切换

### 5. 性能优化

- **避免不必要的条件**：只配置必要的条件，减少条件评估开销
- **合理使用预览**：预览会执行实际查询，不要频繁预览
- **缓存数据**：系统会自动缓存已加载的数据，提高性能

### 6. 配置验证

- **使用预览功能**：配置完成后，使用预览功能验证配置
- **检查字段映射**：确保字段映射符合图表类型的要求
- **测试条件切换**：对于条件数据源，测试不同条件下的切换效果

---

## 总结

数据源绑定功能是报表BI系统的核心功能，通过灵活的配置方式，可以满足不同复杂度的业务需求。系统提供了固定数据源和条件数据源两种类型，支持智能表选择、灵活字段映射、实时数据预览等功能，帮助用户快速完成数据源配置。

**关键要点**：
1. 固定数据源适合大多数场景，配置简单
2. 条件数据源适合需要动态切换的场景，配置相对复杂
3. 表选择是可选的，系统可以自动选择
4. 字段映射根据图表类型自动显示对应的配置项
5. 使用预览功能验证配置是否正确

通过合理使用这些功能，可以高效地完成数据源配置，实现数据的可视化展示。

---

## 附录

### A. 支持的组件类型

- 折线图（line_chart）
- 饼图（pie_chart）
- 下拉列表（dropdown）
- 文本框（text_input）
- 树图（tree_chart）

### B. 组件字段参考

| 组件类型 | 可用字段 | 说明 |
|---------|---------|------|
| 下拉列表 | `value`、`selectedValue` | 当前选中值（两者功能相同） |
| 文本框 | `value` | 输入值 |
| 树图 | `selectedNode`、`value` | 选中节点名称（推荐） |
| 树图 | `selectedNodePath` | 完整路径数组 |
| 图表 | `selectedData` | 选中的数据 |

### C. 操作符说明

| 操作符 | 说明 | 适用类型 |
|-------|------|---------|
| `=` | 等于 | 文本、数值、日期 |
| `!=` | 不等于 | 文本、数值、日期 |
| `>` | 大于 | 数值、日期 |
| `<` | 小于 | 数值、日期 |
| `>=` | 大于等于 | 数值、日期 |
| `<=` | 小于等于 | 数值、日期 |
| `IN` | 包含在列表中 | 文本、数值 |
| `LIKE` | 模糊匹配 | 文本 |

---

**文档版本**：v1.0  
**最后更新**：2024年  
**维护者**：开发团队

